import express, { Router } from "express";
import fileUpload from "express-fileupload";
import multer from "multer";
import findRemoveSync from "find-remove";

let ranVal = cryptoRandomString({ length: 10, type: "alphanumeric" }); // generate a random string of characters to attach to name of files

const storage = multer.diskStorage({
	destination: function (req, file, cb) {
		cb(null, "./uploads");
	},
	filename: function (req, file, cb) {
		cb(null, `${ranVal}_${file.originalname}`);
	},
});

const upload = multer({ storage });

import {
	getAllMenu,
	saveMenu,
	updateMenu,
	deleteMenu,
	getSingledMenu,
	getAllDrinks,
	saveDrink,
	updateDrinks,
	deleteDrinks,
	getSingleDrinks,
	getAllSchedule,
	getSingleSchedule,
	getAllUser,
	saveUser,
	updateUser,
	deleteUser,
	getSingleUser,
	createAdmin,
	adminUserExists,
	isLoginCorrect,
} from "../data/database.js";

import cryptoRandomString from "crypto-random-string";
const router = express.Router();
const app = express();

app.use(express.urlencoded({ extended: true }));

app.use(
	fileUpload({
		limits: {
			fileSize: 50 * 1024 * 1024,
		},
		abortOnLimit: true,
	})
);

// ===============================================================================================================================================================================================

///////////////////////////////////////////   ============ All of Menu ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

// ===============================================================================================================================================================================================

//Get Single Menu

router.get("/lunch-menu/menu-item-view/:id", async (req, res) => {
	const id = req.params.id;
	const [results] = await getSingledMenu(id);
	console.log("=====================================================");
	console.log(results);
	console.log("=====================================================");
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);
	res.render("admin_pages/view-single-menu-item", {
		title: "Menu Item Detail",
		data: results,
		prevUrl,
	});
});
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Create Menu
router.get("/create-menu-item", async (req, res) => {
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);
	res.render("admin_pages/create-menu-item", {
		title: "Create Menu Item",
		prevUrl,
	});
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Update Menu
router.get("/update-menu-item/:id", async (req, res) => {
	const mealItem = await getAllMenu(req.params.id);
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);

	res.render("admin_pages/update-meal-item", {
		title: "Update Menu",
		mealItem,
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Delete Menu
router.get("/lunch-menu/delete-menu-item/:id", async (req, res) => {
	const [mealItem] = await getSingledMenu(req.params.id);
	console.log(mealItem);
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);

	res.render("admin_pages/delete-menu-item", {
		title: "Delete Menu Item",
		mealItem,
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============ All of Drinks ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Get Single Drink

router.get("/lunch-menu/view-drink-item/:id", async (req, res) => {
	const id = req.params.id;
	const [results] = await getSingleDrinks(id);
	console.log("=====================================================");
	console.log(results);
	console.log("=====================================================");
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);

	res.render("admin_pages/view-single-drink-item", {
		data: results,
		title: "Drinks Detail",
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Create Drink

router.get("/create-drink-item", async (req, res) => {
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);

	res.render("admin_pages/create-drink-item", {
		title: "Create Drink Item",
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Update Drinks
router.get("/update-drink", async (req, res) => {
	const mealItem = await getAllDrinks(req.params.id);
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);

	res.render("admin_pages/drink-update", {
		title: "Update Drink",
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Delete Drink
router.get("/lunch-menu/delete-drink-item/:id", async (req, res) => {
	const prevUrl = req.headers.referer.slice("http://localhost:4400".length);
	const [drinkItemData] = await getSingleDrinks(req.params.id);
	console.log(drinkItemData);
	res.render("admin_pages/delete-drink-item", {
		title: "Delete Drink Item",
		drinkItemData,
		prevUrl,
	});
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============ All of User ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Get Single User

app.get("/users/user-person-view/:id", async (req, res) => {
	const id = req.params.id;
	const results = await getSingleUser(id);
	console.log("=====================================================");
	console.log(results);
	console.log("=====================================================");
	res.render("/", { data: results, title: "User Detail" });
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Create User

router.get("/create-user-person", async (req, res) => {
	res.render("admin_pages/drink-item", { title: "Create User" });
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Update User

router.get("/update-user", async (req, res) => {
	const mealItem = await getAllUser(req.params.id);
	res.render("admin_pages/user-update", { title: "Update User" });
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Delete User

router.get("/delete-user-delete/:id", async (req, res) => {
	const mealItem = await getAllUser(req.params.id);
	res.render("admin_pages/user-delete", { title: "Confirm Deletion", id });
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============ All of Schedule ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Get Single Drink

app.get("/schedules/schedule-item-view/:id", async (req, res) => {
	const id = req.params.id;
	const results = await getSingleSchedule(id);
	console.log("=====================================================");
	console.log(results);
	console.log("=====================================================");
	res.render("/", { data: results, title: "Schedule Detail" });
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============== DATABASE ACTIONS ==============   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============ Post For  MENU ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Create Menu Post

router.post("/create-menu-item/submit", upload.single("meal_img"), async (req, res) => {
	const menuItemData = {
		item_name: req.body.meal_name,
		quantity: req.body.quantity,
	};

	if (req.body.desc.length > 255) {
		menuItemData.description = req.body.desc.slice(0, 255);
	} else {
		menuItemData.description = req.body.desc;
	}

	if (req.file) {
		menuItemData.img = `${ranVal}_${req.file.originalname}`;
	} else {
		menuItemData.img = "";
	}

	console.log(menuItemData);
	await saveMenu(menuItemData);
	res.redirect("/tap-canteen/lunch-menu");
});

router.get("/create-menu-item", async (req, res) => {
	res.render("admin_pages/create-menu-item", { title: "Create Menu Item" });
});

// id, beverage, quantity, img, description

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Update Menu Post

router.post("/update-menu", async (req, res) => {
	const menuItemData = {
		id: req.body.id,
		item_name: req.body.item_name,
		quantity: req.body.quantity,
		description: req.body.description,
	};

	menuItemData.img = req.files ? `${getRandomHexValues(8)}_${req.files.image.name}` : "";

	if (req.files) {
		req.files.image.mv("./uploads/" + menuItemData.img);
	}

	console.log(menuItemData);
	await updateMenu(menuItemData);
	res.redirect("/menu");
});

router.get("/update-menu", async (req, res) => {
	res.render("admin_pages/menu-update", { title: "Update Menu" });
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Delete Menu Post

router.get("/delete-menu-item/confirm/:id", async (req, res) => {
	const id = req.params.id;
	const [record] = await getSingledMenu(id);
	if (record.img) {
		findRemoveSync("./uploads", { files: record.img });
	}
	console.log("Deleting menu item with ID:", id);
	console.log(record);
	await deleteMenu(id);
	res.redirect("/tap-canteen/lunch-menu");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Get a Single Menu Post

router.post("/get-single-menu-item/:id", async (req, res) => {
	const menuId = req.body.id;

	console.log("getting the menu", menuId);
	const menuItem = await getSingledMenu(menuId);
	console.log("getting  menu item:", menuItem);
	res.redirect("/");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============== Post For  Drinks ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Create Drinks Post

router.post("/create-drink-item/submit", upload.single("drink_img"), async (req, res) => {
	const drinkItemData = {
		beverage: req.body.drink_name,
		quantity: req.body.quantity,
	};

	if (req.body.desc.length > 255) {
		drinkItemData.description = req.body.desc.slice(0, 255);
	} else {
		drinkItemData.description = req.body.desc;
	}

	if (req.file) {
		drinkItemData.img = `${ranVal}_${req.file.originalname}`;
	} else {
		drinkItemData.img = "";
	}

	console.log(drinkItemData);
	await saveDrink(drinkItemData);
	res.redirect("/tap-canteen/lunch-menu");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Update Drink Post
router.post("/update-drink-item", async (req, res) => {
	const drinkItemData = {
		id: req.body.id,
		beverage: req.body.beverage,
		quantity: req.body.quantity,
		description: req.body.description,
		img: req.files ? `${getRandomHexValues(8)}_${req.files.image.name}` : "",
	};

	if (req.files) {
		req.files.image.mv("./uploads/" + drinkItemData.img);
	}

	console.log(drinkItemData);
	await updateDrinks(drinkItemData);
	res.redirect("/");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Delete Drinks Post

router.get("/delete-drink-item/confirm/:id", async (req, res) => {
	const id = req.params.id;
	const [record] = await getSingleDrinks(id);
	if (record.img) {
		findRemoveSync("./uploads", { files: record.img });
	}

	console.log(record);
	console.log("Deleting drink item with ID:", id);
	await deleteDrinks(id);
	res.redirect("/tap-canteen/lunch-menu");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// Get a Single drink Post

router.post("/get-single-drink-item", async (req, res) => {
	const menuId = req.body.id;

	console.log("getting the drink", menuId);
	const menuItem = await getSingleDrinks(menuId);
	console.log("getting  menu item:", menuItem);
	res.redirect("/");
});
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////   ============== Post For  Schedule ==============   //////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Create Meal Schedule

// router.post('/create-mealschedule', async (req, res) => {
//     const menuItemData = {
//         item_name: req.body.item_name,
//         quantity: req.body.quantity,
//         description: req.body.description,
//         img: req.body.img
//     }

//     console.log(menuItemData);
//     await saveMenu(menuItemData);
//     res.redirect('/');
// });
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//! DO NOT CREATE ANY ROUTES BELOW THIS EXPORT
export const adminRoute = router;
